# LockBit

## Scenario:

A medium-sized corporation has experienced a ransomware attack, first identified when a user reported a ransom note on their screen alongside a Windows Defender alert indicating malicious activity. Your task is to analyze logs provided from the compromised machines and identify the ransomware's entry point.

## Walkthrough & Analysis

### Looking at Microsoft Protection Logs (MPlog.txt)
![2024-09-17_21-13](https://github.com/user-attachments/assets/6df25bd1-bdd5-4a60-a201-925ff9da4788)

Starting with the Domain Controller (DC01), I examine the Defender logs to identify any flagged activites on ths system.

A suspicious executable file in the ADMIN$ share on the Domain Controller raises immediate concern.

![2024-09-17_21-18](https://github.com/user-attachments/assets/17ffac01-6d8e-4dfc-b90a-bba760a7e361)

MPLogs, or "Microsoft Protection" logs, are generated by Defender or MS Security Essentials. They provide a good initial overview of potential threats on the system.

As seen, we observe the supposed CobaltStrike executable adding a file path to the exclusions list, instructing Defender to skip scanning the entire "C:\\" drive path for malicious activity.

![2024-09-17_21-40](https://github.com/user-attachments/assets/a144fe9e-ed2e-4f39-813d-bb7762a2c866) 
-----------------------------
![2024-09-17_21-41](https://github.com/user-attachments/assets/ca68fad1-0fb0-4b47-8e87-c6e273d22f15)

Comparing these two event logs reveals communication between two internal IPs (the DC and another machine) through unusual port numbers just before the malicious software installation.

To confirm 192.168.170.142 as the IP address of the Domain Controller, we examine the SYSTEM root hive of the DC01 triage image.

### Using Registry Explorer to Locate DC01's Assigned IP
![image](https://github.com/user-attachments/assets/2ae4bd77-00c5-463b-addb-010f6d6600af)

This IP address is confirmed as the only one assigned to the DC01 system.

I could spend all day snooping around in this KAPE image. Instead of getting tunnelvision, I will pivot to analyzing the SQL server to understand the attack's scope better, starting again with the Defender logs.

### Analyzing MPlogs on SQL Server
![2024-09-18_00-51](https://github.com/user-attachments/assets/190334d8-66ab-47b8-a910-0a7ad1fdb4d6)

Defender has detected and blocked cmd.exe from executing commands, warranting further investigation.

### Examining Windows (Sysmon) Event Logs
![2024-09-18_01-24](https://github.com/user-attachments/assets/a534d0b3-c850-4711-869a-0ecf71892685)

We observe the same Process ID (PID) being spawned from the sqlservr executable in the Program Files directory. This cmd.exe process uses PowerShell to download a payload script from a remote IP address.

So far, we have confirmed two infections, but how did the attacker gain access to the SQL server? Luckily, in our KAPE data, we have MSSQL error logs, which can provide us with valuable insight into the server's activity during this timeframe.

![2024-09-18_01-59](https://github.com/user-attachments/assets/f021d4cd-abae-499e-b18e-3157cfcc8718)

These logs reveal that the attacker brute-forced their way into the SQL server and subsequently enabled the "xp_cmdshell" feature, allowing remote command execution.

Returning to the Sysmon logs, our attack timeline becomes clearer. After enabling xp_cmdshell, PowerShell executes a sequence of commands:
1. Uses Uses "IEX (New-Object Net.WebClient).DownloadString" to download a PowerShell script from a remote host.
2. Injects into winlogon.exe [PID 596] -> Creates Remote Pipe to \postex_c352 (CobaltStrike Post Exploitation Framework).
3. Executes encoded PowerShell payloads in memory.
4. Dumps lsass.exe process and extracts credentials.

![2024-09-18_02-31](https://github.com/user-attachments/assets/df74830d-5008-49c0-89f9-009925bdcee0)

We notice a familiar pattern: the payload creates a Defender exclusion for the folder path "C:\\" on both FileServer and DevPC.

![2024-09-18_03-07](https://github.com/user-attachments/assets/8118d9d2-3f9c-4df0-81db-5d4edea98ca8)

Firstly, On FileServer we see a malicious executable blocked by Defender.

Now to look at DevPC...

![2024-09-18_03-13](https://github.com/user-attachments/assets/a1d86f9a-4256-4396-82eb-bb2cf58de538)

The 32-bit version of Rundll32.exe creating vmware.exe in the Temp folder is highly suspicious and warrants investigation.

![image](https://github.com/user-attachments/assets/247c060e-2bd1-4fe5-8677-2da5dc1962b4)

Since I have VMware installed locally I decided to double check. As I expected, the default path for the vmware executable file will be in either Program Files or Program Files (x86).

![2024-09-18_03-17](https://github.com/user-attachments/assets/5f59fd04-6fea-4e31-bc76-95a4f612e9d4)

![2024-09-18_03-19](https://github.com/user-attachments/assets/6977ac4a-8ba2-4ca6-9bce-14be52d264c8)

### Ransomware Execution 

The malicious executable creates a README.txt file in the Downloads folder and subsequently overwrites every file in the C:\ drive, indicating a successful ransomware attack.

### Conclusion

This analysis reveals a sophisticated ransomware attack involving multiple stages:
1. Initial compromise of the SQL server through brute-force attacks.
2. Utilization of SQL server features for command execution.
3. Lateral movement to other systems using domain Shares.
4. Deployment and execution of the LockBit ransomware.

### Takeaways

You probably can't tell from how concise of a writeup this is, but I actually spent a decent amount of time on this challenge -more than I should've. One thing I am learning as an analyst is to recognize when I'm starting to get tunnelvision and to remain focused on the bigger picture. With proper context, I'm able to more efficently navigate and replicate the attacker's moves. 

